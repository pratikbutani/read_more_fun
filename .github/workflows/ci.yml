name: Build APK

# This workflow is triggered on pushes to the repository.

on:
  push:
    branches:
      - dev

    # on: push    # Default will running for every branch.

jobs:
  # CI
  build:
    # This job will run on ubuntu virtual machine
    runs-on: ubuntu-latest
    steps:
      
      # Setup Java environment in order to build the Android app.
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v1
        with:
          java-version: '11.x'

      - name: Decrypt Android keys
        run: sh ./.github/scripts/decrypt_android_secrets.sh
        env:
          ANDROID_KEYS_SECRET_PASSPHRASE: ${{ secrets.ANDROID_KEYS_SECRET_PASSPHRASE }}

      # Creating new file to copy the data of google service json file
      - name: Create file
        run: |
         ls
         var=$(ls)
         echo "Dir $var"
         ls
         var=$(ls)
         echo "Dir $var"
         cat /home/runner/work/read_more_fun/read_more_fun/android/app/google-services.json | base64

      # Copying data and putting into google_services.json from secret
      - name: Putting data
        env:
          DATA: ${{ secrets.GOOGLE_SERVICE_JSON }}
        run: echo $DATA > /home/runner/work/read_more_fun/read_more_fun/android/app/google-services.json

      # Setup the flutter environment.
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.0.1'

      # Get flutter dependencies.
      - name: Flutter Getting Pubs
        run: flutter pub get

      # Add build runner commands here if you have any
      - name: Format files
        run: flutter format --set-exit-if-changed .

#      - name: Analyze files
#        run: flutter analyze .
#
#      - name: Run the tests
#        run: flutter test

      - name: Build the APK
        run: flutter build appbundle --release

      - name: Run Fastlane
        uses: maierj/fastlane-action@v1.4.0
        with:
          lane: beta
          subdirectory: android
